<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARC Call Capacity</title>
  <style>
    /* ===== THEME TOKENS ===== */
    :root {
      /* light (default) */
      --bg:#ffffff;
      --card:#f9fafb;
      --text:#1e293b;
      --muted:#64748b;
      --brand:#0284c7;
      --ok:#16a34a;
      --warn:#f59e0b;
      --full:#dc2626;
      --grid:#e2e8f0;
      --input-bg:#ffffff;
      --hover:rgba(2,132,199,.06);
    }
    [data-theme="dark"] {
      --bg:#0b0f14;
      --card:#121820;
      --muted:#94a3b8;
      --text:#e5edf5;
      --brand:#38bdf8;
      --ok:#22c55e;
      --warn:#f59e0b;
      --full:#ef4444;
      --grid:#1e293b;
      --input-bg:#0f172a;
      --hover:rgba(56,189,248,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font:16px/1.5 "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      transition:background 0.3s,color 0.3s;
    }

    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;gap:12px}
    h1{font-size:22px;margin:0;font-weight:600;color:var(--brand)}
    .muted{color:var(--muted)}

    .theme-toggle-wrapper{
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .theme-toggle-wrapper:hover .toggle-switch{
      border-color:var(--brand);
    }
    .theme-icon{
      width:20px;
      height:20px;
      transition:transform 0.3s;
    }
    .theme-icon svg{
      width:100%;
      height:100%;
      stroke:var(--text);
      fill:none;
    }
    .theme-toggle-wrapper:hover .theme-icon{
      transform:scale(1.1);
    }
    .toggle-switch{
      position:relative;
      width:44px;
      height:24px;
      background:var(--grid);
      border:2px solid var(--grid);
      border-radius:999px;
      transition:all 0.3s;
    }
    .toggle-switch::before{
      content:'';
      position:absolute;
      top:2px;
      left:2px;
      width:16px;
      height:16px;
      background:var(--text);
      border-radius:50%;
      transition:transform 0.3s;
    }
    [data-theme="dark"] .toggle-switch{
      background:var(--brand);
      border-color:var(--brand);
    }
    [data-theme="dark"] .toggle-switch::before{
      transform:translateX(20px);
      background:#fff;
    }

    .card{
      background:var(--card);
      border:1px solid var(--grid);
      border-radius:16px;
      padding:16px;
      box-shadow:0 8px 24px rgba(0,0,0,.05);
      transition:background .3s,border .3s;
    }

    .controls{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 16px}
    select,input{background:var(--input-bg);color:var(--text);border:1px solid var(--grid);padding:8px 10px;border-radius:10px;outline:none}

    table{width:100%;border-collapse:separate;border-spacing:0}
    th,td{padding:12px 10px;border-bottom:1px solid var(--grid);vertical-align:middle}
    th{font-weight:600;color:var(--muted);text-align:left}
    tr:hover td{background:var(--hover)}

    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px;margin:16px 0}
    .kpi{background:var(--input-bg);border:1px solid var(--grid);border-radius:14px;padding:12px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:22px;font-weight:700}

    .bar{position:relative;height:14px;background:var(--grid);border-radius:999px;overflow:hidden}
    .bar > span{position:absolute;left:0;top:0;height:100%;display:block}

    .tag{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--grid)}
    .tag.ok{background:rgba(34,197,94,.12);color:var(--ok)}
    .tag.full{background:rgba(239,68,68,.12);color:var(--full)}
    .tag.warn{background:rgba(245,158,11,.12);color:var(--warn)}

    .foot{margin-top:10px;color:var(--muted);font-size:12px}
    
    .refresh-btn{
      cursor:pointer;
      padding:8px;
      border-radius:8px;
      transition:background 0.2s;
      display:flex;
      align-items:center;
      justify-content:center;
      border:none;
      background:transparent;
    }
    .refresh-btn:hover{
      background:var(--hover);
    }
    .refresh-btn svg{
      width:18px;
      height:18px;
      stroke:var(--muted);
      transition:transform 0.3s;
    }
    .refresh-btn:hover svg{
      stroke:var(--text);
    }
    .refresh-btn.spinning svg{
      animation:spin 0.6s linear;
    }
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }

    /* Mobile card view */
    .table-card{
      display:none;
    }
    
    @media (max-width:800px){
      .kpis{grid-template-columns:repeat(2,1fr)}
      
      .controls{display:none}
      .tablewrap{display:none}
      .table-card{
        display:block;
      }
      .week-card{
        background:var(--input-bg);
        border:1px solid var(--grid);
        border-radius:12px;
        padding:14px;
        margin-bottom:12px;
      }
      .week-card-header{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:12px;
      }
      .week-label{
        font-weight:600;
        display:flex;
        align-items:center;
        gap:8px;
      }
      .card-row{
        display:flex;
        justify-content:space-between;
        padding:6px 0;
        font-size:14px;
      }
      .card-row .label{
        color:var(--muted);
      }
      .card-row .value{
        font-weight:500;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ARC Call Capacity</h1>
      <div class="theme-toggle-wrapper" id="themeToggle">
        <span class="theme-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
          </svg>
        </span>
        <div class="toggle-switch"></div>
        <span class="theme-icon">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </span>
      </div>
    </header>

    <div class="card">
      <div class="card-header">
        <div></div>
        <button class="refresh-btn" id="refreshBtn" title="Refresh data">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
          </svg>
        </button>
      </div>
      <div class="controls">
        <label>Week:
          <select id="weekFilter"></select>
        </label>
        <label>Status:
          <select id="statusFilter">
            <option value="">All</option>
            <option value="Healthy">Healthy</option>
            <option value="Busy">Busy</option>
            <option value="Max Capacity">Max Capacity</option>
          </select>
        </label>
        <input id="search" placeholder="Search week (e.g., Nov 2 – 8)" />
      </div>

      <div class="kpis">
        <div class="kpi"><div class="label">Weeks</div><div class="value" id="kWeeks">-</div></div>
        <div class="kpi"><div class="label">Total Capacity</div><div class="value" id="kCapacity">-</div></div>
        <div class="kpi"><div class="label">Total Workload</div><div class="value" id="kDemand">-</div></div>
        <div class="kpi"><div class="label">Avg Utilization</div><div class="value" id="kUtil">-</div></div>
      </div>

      <div class="tablewrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Week</th>
              <th>Capacity</th>
              <th>Workload</th>
              <th>Remaining</th>
              <th style="width:240px">Utilization</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="table-card" id="mobileCards"></div>

      <div class="foot" id="lastUpdated">—</div>
    </div>
  </div>

  <script>
    /* ===== THEME TOGGLE ===== */
    const themeToggle = document.getElementById('themeToggle');
    const htmlEl = document.documentElement;

    function setTheme(theme){
      htmlEl.setAttribute('data-theme', theme);
      localStorage.setItem('arcTheme', theme);
    }

    themeToggle.addEventListener('click',()=>{
      const current = htmlEl.getAttribute('data-theme');
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    // Load saved preference, otherwise default to light
    const saved = localStorage.getItem('arcTheme');
    if(saved){ 
      setTheme(saved); 
    } else { 
      setTheme('light'); 
    }

    /* ===== DASHBOARD ===== */
    // ======== CONFIGURE THESE VALUES ========
    const SHEET_ID   = '1vkxESiOY3-dDEdaCnvYLbYGHAynrRQWav8FgGXtJJLs';
    const SHEET_NAME = 'CapacityData';   // exact tab name
    const CSV        = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQs3XlDGAq7KpR7ltl7a4Ii_4ef_GMsfzDAVdEMuJqvdNbwAuJibG7r73whtAg2_1ZKcmtt5UUFVbzX/pub?gid=0&single=true&output=csv';
    // ========================================

    // JSONP endpoint (bypasses CORS if opened as a local file)
    const GVIZ_JSONP = (cb)=>`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(SHEET_NAME)}&tqx=responseHandler:${cb}`;

    const $ = (sel)=>document.querySelector(sel);

    // ---------- Helpers ----------
    function fmtNumber(n){ return Number(n).toLocaleString(); }
    function fmtPct(x){ return (Number(x)*100).toFixed(0)+'%'; }

    // Convert Google Sheets serial date -> JS Date, else try native
    function gsSerialToDate(v){
      if (typeof v === 'number' && v > 30000) { // typical serials like 45559
        return new Date(Math.round((v - 25569) * 86400 * 1000));
      }
      const d = new Date(v);
      return isNaN(d) ? null : d;
    }
    function toISO(d){
      const dt = gsSerialToDate(d);
      if(!dt) return d;
      const m = String(dt.getMonth()+1).padStart(2,'0');
      const day = String(dt.getDate()).padStart(2,'0');
      return `${dt.getFullYear()}-${m}-${day}`;
    }

    // CSV parser (handles quotes + commas)
    function parseCSV(csv){
      const out=[]; let row=[]; let cur=''; let inQ=false;
      const push=()=>{ row.push(cur); cur=''; };
      for(let i=0;i<csv.length;i++){
        const ch = csv[i];
        if(inQ){
          if(ch === '"'){ if(csv[i+1] === '"'){ cur+='"'; i++; } else { inQ=false; } }
          else { cur += ch; }
        }else{
          if(ch === '"'){ inQ=true; }
          else if(ch === ','){ push(); }
          else if(ch === '\n'){ push(); out.push(row); row=[]; }
          else if(ch === '\r'){ /* ignore */ }
          else { cur += ch; }
        }
      }
      if(cur.length || row.length){ push(); out.push(row); }
      const headers = out.shift();
      return out.filter(r=>r.length && r.some(x=>x!==''))
        .map(r=>{ const o={}; headers.forEach((h,i)=>o[h]=r[i]); return o; });
    }

    // GViz → rows
    function fromGvizObj(resp){
      const cols = resp.table.cols.map(c=>c.label || c.id);
      return resp.table.rows.map(r=>{
        const o={};
        r.c.forEach((cell,i)=>{
          const key = cols[i] || `col${i}`;
          let v = cell ? (cell.f ?? cell.v) : null;
          o[key]=v;
        });
        return o;
      });
    }

    // ---------- Render ----------
    function render(data){
      // Map sheet → normalized
      const map = (r)=>({
        Week: r.Week ?? r['Week Label'] ?? '',
        Start: r.Start ?? r['Week Start'] ?? r['Event Period'] ?? '', // optional/hidden
        End:   r.End   ?? r['Week End']   ?? '',
        Capacity: Number(String(r.Capacity||'').replace(/,/g,'')),
        Workload: Number(String((r.Workload ?? r.Demand) || '').replace(/,/g,'')), // Demand→Workload
        Utilization: (()=>{ let u=(r.Utilization ?? r['Usage'] ?? r['Load']);
          if (typeof u === 'string'){
            if (u.includes('%')) u = Number(u.replace('%',''))/100;
            else u = Number(u);
          }
          return Number(u);
        })(),
        Status: r.Status || '' // optional, we derive if absent
      });

      // Keep spreadsheet order
      const rows = data.map(map).filter(r => r.Week || r.Start);

      // Week filter options in the same order as rows
      const seen = new Set();
      const uniqWeeks = [];
      for (const r of rows) {
        const label = r.Week || `${toISO(r.Start)}${r.End?` – ${toISO(r.End).slice(5)}`:''}`;
        if (label && !seen.has(label)) { seen.add(label); uniqWeeks.push(label); }
      }
      $('#weekFilter').innerHTML = '<option value="">All weeks</option>' + uniqWeeks.map(w=>`<option>${w}</option>`).join('');

      // Status helpers - changed Busy threshold to 85%
      function deriveStatus(u){
        if (u > 1) return 'Max Capacity';
        if (u >= 0.85) return 'Busy';
        return 'Healthy';
      }
      function statusClass(label){
        const l = (label||'').toLowerCase();
        if (l.includes('max')) return 'full';
        if (l.includes('busy')) return 'warn';
        return 'ok'; // Healthy
      }
      function tag(label){
        return `<span class="tag ${statusClass(label)}">${label}</span>`;
      }

      function paint(list){
        // KPIs
        document.querySelector('#kWeeks').textContent    = list.length;
        document.querySelector('#kCapacity').textContent = fmtNumber(list.reduce((s,r)=>s+r.Capacity,0));
        document.querySelector('#kDemand').textContent   = fmtNumber(list.reduce((s,r)=>s+r.Workload,0)); // label: Total Workload
        const avgU = list.length ? list.reduce((s,r)=>s+(isFinite(r.Utilization)?r.Utilization:0),0)/list.length : 0;
        document.querySelector('#kUtil').textContent     = fmtPct(avgU);

        // Table (desktop)
        const tbody = document.querySelector('#tbl tbody');
        tbody.innerHTML = '';
        
        // Mobile cards
        const mobileCards = document.querySelector('#mobileCards');
        mobileCards.innerHTML = '';
        
        list.forEach(r=>{
          const remaining = r.Capacity - r.Workload;
          const weekLabel = r.Week || `${toISO(r.Start)}${r.End?` – ${toISO(r.End).slice(5)}`:''}`;
          const statusLabel = r.Status || deriveStatus(r.Utilization);
          const statusColor = r.Utilization>1?'var(--full)':(r.Utilization>=0.85?'var(--warn)':'var(--ok)');
          
          // Desktop table row
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>
              <span style="height:10px;width:10px;border-radius:50%;display:inline-block;margin-right:8px;background:${statusColor}"></span>
              ${weekLabel}
            </td>
            <td>${fmtNumber(r.Capacity)}</td>
            <td>${fmtNumber(r.Workload)}</td>
            <td>${fmtNumber(remaining)}</td>
            <td>
              <div class="bar">
                <span style="width:${Math.min(100,(r.Utilization*100)||0)}%;
                             background:${statusColor}"></span>
              </div>
              <div class="muted" style="margin-top:4px">${fmtPct(r.Utilization)}</div>
            </td>
            <td>${tag(statusLabel)}</td>`;
          tbody.appendChild(tr);
          
          // Mobile card
          const card = document.createElement('div');
          card.className = 'week-card';
          card.innerHTML = `
            <div class="week-card-header">
              <div class="week-label">
                <span style="height:10px;width:10px;border-radius:50%;display:inline-block;background:${statusColor}"></span>
                ${weekLabel}
              </div>
              ${tag(statusLabel)}
            </div>
            <div class="card-row">
              <span class="label">Remaining</span>
              <span class="value">${fmtNumber(remaining)}</span>
            </div>
            <div class="card-row">
              <span class="label">Utilization</span>
              <span class="value">${fmtPct(r.Utilization)}</span>
            </div>
            <div class="bar" style="margin-top:8px">
              <span style="width:${Math.min(100,(r.Utilization*100)||0)}%;
                           background:${statusColor}"></span>
            </div>`;
          mobileCards.appendChild(card);
        });
      }

      function applyFilters(){
        const w = document.querySelector('#weekFilter').value;
        const s = document.querySelector('#statusFilter').value;
        const q = document.querySelector('#search').value.trim().toLowerCase();
        let list = rows.slice();
        if (w) list = list.filter(r=> {
          const label = r.Week || `${toISO(r.Start)}${r.End?` – ${toISO(r.End).slice(5)}`:''}`;
          return label === w;
        });
        if (s) list = list.filter(r=> {
          const label = r.Status || (r.Utilization>1?'Max Capacity':(r.Utilization>=0.85?'Busy':'Healthy'));
          return label.toLowerCase() === s.toLowerCase();
        });
        if (q) list = list.filter(r=> (r.Week || '').toLowerCase().includes(q));
        paint(list);
      }

      document.querySelector('#weekFilter').onchange = applyFilters;
      document.querySelector('#statusFilter').onchange = applyFilters;
      document.querySelector('#search').oninput = applyFilters;

      paint(rows);
    }

    // ---------- Loader (JSONP first, CSV fallback) ----------
    function loadViaJSONP(){
      return new Promise((resolve,reject)=>{
        const cb = 'gviz_cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        window[cb] = (resp)=>{ try{ resolve(fromGvizObj(resp)); } catch(e){ reject(e); } finally { delete window[cb]; s.remove(); } };
        s.src = GVIZ_JSONP(cb);
        s.onerror = ()=>{ delete window[cb]; reject(new Error('JSONP load error')); };
        document.body.appendChild(s);
      });
    }

    async function main(){
      const refreshBtn = document.getElementById('refreshBtn');
      refreshBtn.classList.add('spinning');
      
      try{
        const data = await loadViaJSONP();
        render(data);
      }catch(err){
        console.warn('JSONP failed, trying CSV…', err);
        try{
          const res = await fetch(CSV + '&cb=' + Date.now()); // cache-buster
          const csv = await res.text();
          const data = parseCSV(csv);
          render(data);
        }catch(err2){
          console.error('Both JSONP and CSV failed', err2);
          alert('Failed to load data.');
          refreshBtn.classList.remove('spinning');
          return;
        }
      }
      document.querySelector('#lastUpdated').textContent = `Updated ${new Date().toLocaleString('en-US', { 
        month: 'long', 
        day: 'numeric', 
        year: 'numeric', 
        hour: 'numeric', 
        minute: '2-digit', 
        hour12: true 
      })}`;
      refreshBtn.classList.remove('spinning');
    }

    // Refresh button handler
    document.getElementById('refreshBtn').addEventListener('click', main);

    main();
  </script>
</body>
</html>
